<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Man Thong Auto Trading Stock List</title>
<style>
    /* ---------------------------------- */
    /* Base Layout and Header */
    /* ---------------------------------- */
    body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4;
        color: #333;
    }

    .header {
        background-color: #007bff;
        color: white;
        padding: 20px 10px;
        text-align: center;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .header-content {
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 20px;
        max-width: 1000px;
        margin: 0 auto;
    }

    .logo {
        height: 50px;
        width: auto;
        border-radius: 8px;
    }

    .header h1 {
        margin: 0;
        font-size: 2em;
    }

    .controls {
        padding: 15px;
        background-color: #fff;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        text-align: center;
    }

    #search-input {
        width: 90%;
        max-width: 500px;
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 5px;
        font-size: 16px;
    }

    .main-content {
        max-width: 1200px;
        margin: 20px auto;
        padding: 0 15px;
    }

    /* ---------------------------------- */
    /* Car List and Categories */
    /* ---------------------------------- */

    .brand-category-title {
        background-color: #e9ecef;
        color: #007bff;
        padding: 10px 15px;
        margin-top: 30px;
        margin-bottom: 10px;
        font-size: 1.8em;
        border-bottom: 3px solid #007bff;
        border-radius: 5px 5px 0 0;
    }
    
    .dealership-separator {
        color: #28a745;
        text-align: center;
        padding: 10px;
        margin-top: 20px;
        margin-bottom: 15px;
        font-size: 1.2em;
        border-top: 1px solid #ddd;
        border-bottom: 1px solid #ddd;
        background-color: #f8f9fa;
    }

    .category-title {
        font-size: 1.4em;
        color: #6c757d;
        border-left: 5px solid #ffc107;
        padding-left: 10px;
        margin-top: 15px;
        margin-bottom: 10px;
    }

    .car-list {
        list-style: none;
        padding: 0;
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 20px;
    }

    .car-item {
        background-color: white;
        padding: 20px;
        border-radius: 8px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        position: relative;
        overflow: hidden;
        transition: transform 0.2s;
        border: 1px solid #ccc; /* Standard border for available cars */
    }

    .car-item:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.15);
    }

    .car-title {
        font-size: 1.4em;
        color: #007bff;
        margin-top: 0;
        border-bottom: 2px solid #f4f4f4;
        padding-bottom: 5px;
        margin-bottom: 10px;
        padding-left: 50px; /* Space for the tag */
        box-sizing: border-box; 
    }

    .car-price {
        font-size: 1.2em;
        color: #dc3545;
        font-weight: bold;
        margin: 10px 0 5px 0;
    }

    .car-monthly {
        font-size: 1.1em;
        color: #28a745;
        margin: 5px 0 15px 0;
    }

    .car-year, .car-plateno {
        color: #6c757d;
        margin: 3px 0;
    }

    .car-status {
        font-weight: bold;
        color: #28a745; /* Available status color */
    }

    /* ---------------------------------- */
    /* Tags */
    /* ---------------------------------- */
    .tag-top-left {
        position: absolute;
        top: 10px;
        left: 10px; 
        padding: 3px 8px;
        border-radius: 4px;
        font-weight: bold;
        font-size: 0.8em;
        z-index: 10;
    }

    .manthong-tag {
        background-color: #ffc107; /* Man Thong - Yellow */
        color: #333;
    }

    .ef-tag {
        background-color: #17a2b8; /* EF - Cyan */
        color: white;
    }

    /* ---------------------------------- */
    /* WhatsApp Button */
    /* ---------------------------------- */
    .whatsapp-btn {
        display: block;
        background-color: #25d366;
        color: white;
        text-align: center;
        padding: 10px;
        border-radius: 5px;
        text-decoration: none;
        font-weight: bold;
        margin-top: 15px;
        transition: background-color 0.2s;
    }

    .whatsapp-btn:hover {
        background-color: #128c7e;
    }

    /* ---------------------------------- */
    /* Footer */
    /* ---------------------------------- */
    .footer {
        text-align: center;
        padding: 15px;
        background-color: #343a40;
        color: #ccc;
        margin-top: 40px;
        font-size: 0.9em;
    }

    /* ---------------------------------- */
    /* Calculator Pop-up */
    /* ---------------------------------- */
    .calculator-icon {
        position: fixed;
        bottom: 20px;
        right: 20px;
        background-color: #ffc107;
        color: #333;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        text-align: center;
        line-height: 50px;
        font-size: 24px;
        cursor: pointer;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
        z-index: 1000;
    }

    .calculator-popup {
        position: fixed;
        bottom: 80px;
        right: 20px;
        width: 300px;
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
        padding: 20px;
        z-index: 999;
        display: none; /* Hidden by default */
    }

    .calculator-popup h4 {
        margin-top: 0;
        color: #007bff;
        border-bottom: 2px solid #f4f4f4;
        padding-bottom: 10px;
        margin-bottom: 15px;
    }

    .calc-group {
        margin-bottom: 15px;
    }

    .calc-group label {
        display: block;
        font-size: 0.9em;
        margin-bottom: 5px;
        font-weight: bold;
    }

    .calc-group input[type="number"], .calc-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ccc;
        border-radius: 4px;
        box-sizing: border-box;
        font-size: 16px;
    }

    #monthly-payment-result {
        text-align: center;
        margin-top: 20px;
        padding: 15px;
        background-color: #d4edda;
        color: #155724;
        border-radius: 5px;
        font-size: 1.8em;
        font-weight: bold;
    }

    #monthly-payment-result span {
        display: block;
        font-size: 0.6em;
        font-weight: normal;
        margin-top: 5px;
        color: #155724;
    }
    /* ---------------------------------- */
/* Add/Edit Car Modal */
/* ---------------------------------- */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(0, 0, 0, 0.6);
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    padding: 20px;
    opacity: 0;
    visibility: hidden;
    transition: all 0.3s;
}

.modal-overlay.active {
    opacity: 1;
    visibility: visible;
}

.modal {
    background: white;
    border-radius: 12px;
    box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
    width: 100%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.9);
    transition: all 0.3s;
}

.modal-overlay.active .modal {
    transform: scale(1);
}

.modal-header {
    padding: 20px;
    border-bottom: 1px solid #e9ecef;
    display: flex;
    justify-content: space-between;
    align-items: center;
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    border-radius: 12px 12px 0 0;
}

.modal-header h3 {
    margin: 0;
    color: var(--primary);
    display: flex;
    align-items: center;
    gap: 10px;
}

.close-modal {
    background: none;
    border: none;
    font-size: 24px;
    cursor: pointer;
    color: var(--secondary);
    transition: all 0.3s;
    width: 36px;
    height: 36px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

.close-modal:hover {
    background-color: rgba(0, 0, 0, 0.1);
    color: var(--dark);
}

.modal-body {
    padding: 20px;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: var(--dark);
}

.form-control {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    box-sizing: border-box;
    transition: all 0.3s;
}

.form-control:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
}

.form-row {
    display: flex;
    gap: 15px;
}

.form-row .form-group {
    flex: 1;
}

.checkbox-group {
    display: flex;
    gap: 20px;
    margin-top: 10px;
}

.checkbox-item {
    display: flex;
    align-items: center;
    gap: 8px;
}

.checkbox-item input {
    width: 18px;
    height: 18px;
}

.modal-footer {
    padding: 20px;
    border-top: 1px solid #e9ecef;
    display: flex;
    justify-content: flex-end;
    gap: 10px;
    background-color: #f8f9fa;
    border-radius: 0 0 12px 12px;
}

/* Delete confirmation */
.delete-confirm {
    text-align: center;
    padding: 20px;
}

.delete-confirm p {
    margin-bottom: 20px;
    font-size: 1.1em;
}

/* Action buttons in controls */
.action-buttons {
    display: flex;
    gap: 10px;
}

.btn {
    padding: 10px 20px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s;
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
}

.btn-primary {
    background-color: var(--primary);
    color: white;
}

.btn-primary:hover {
    background-color: #0056b3;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
}

.btn-success {
    background-color: var(--success);
    color: white;
}

.btn-success:hover {
    background-color: #218838;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

.btn-danger {
    background-color: var(--danger);
    color: white;
}

.btn-danger:hover {
    background-color: #c82333;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(220, 53, 69, 0.3);
}

/* Notification styles */
@keyframes slideIn {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
:root {
    --primary: #007bff;
    --secondary: #6c757d;
    --success: #28a745;
    --warning: #ffc107;
    --danger: #dc3545;
    --light: #f8f9fa;
    --dark: #343a40;
}
</style>
</head>
<body>

    <div class="header">
        <div class="header-content">
            <img src="Z (4) - Copy.png" alt="Man Thong Auto Trading Logo" class="logo">
            
            <h1>Stock List</h1>
        </div>
    </div>

<div class="controls">
    <input type="text" id="search-input" placeholder="Enter keyword, model, or year...">
    <div class="action-buttons">
        <button class="btn btn-primary" id="add-car-btn">
            <span>➕</span> Add Car
        </button>
        <button class="btn btn-success" id="save-data-btn">
            <span>💾</span> Save Data
        </button>
        <button class="btn btn-danger" id="reset-data-btn">
            <span>🔄</span> Reset Data
        </button>
    </div>
</div>

    <div class="main-content" id="car-container">
        <p style="text-align: center; margin-top: 50px;">Loading vehicle data...</p>
    </div>
    
    <div class="calculator-icon" id="calc-toggle">
        &#x270E; 
    </div>

    <div class="calculator-popup" id="calculator-popup">
        <h4>Car Loan Calculator</h4>
        
        <div class="calc-group">
            <label for="otr-price">Car OTR (RM)</label>
            <input type="number" id="otr-price" placeholder="e.g.: 60000" value="60000">
        </div>

        <div class="calc-group">
            <label for="down-payment">Down Payment (RM)</label>
            <input type="number" id="down-payment" placeholder="e.g.: 6000" value="6000">
        </div>

        <div class="calc-group">
            <label for="loan-years">Loan Years</label>
            <select id="loan-years">
                <option value="9">9 Years</option>
                <option value="8">8 Years</option>
                <option value="7">7 Years</option>
                <option value="6">6 Years</option>
                <option value="5">5 Years</option>
                <option value="4">4 Years</option>
                <option value="3" selected>3 Years</option>
                <option value="2">2 Years</option>
                <option value="1">1 Year</option>
            </select>
        </div>
        
        <div class="calc-group interest-rate-group" id="interest-rate-group">
            <label for="interest-rate">Annual Interest Rate (p.a.)</label>
            <select id="interest-rate">
                <option value="0.036">3.6%</option>
                <option value="0.038">3.8%</option>
                <option value="0.075">7.5%</option>
                <option value="0.079">7.9%</option>
                <option value="0.10" selected>10.0%</option>
            </select>
        </div>
        
        <div id="monthly-payment-result">
            RM 0.00
            <span>Estimated Monthly Payment</span>
        </div>
    </div>
    <!-- Add/Edit Car Modal -->
<div class="modal-overlay" id="car-modal">
    <div class="modal">
        <div class="modal-header">
            <h3><span id="modal-icon">🚗</span> <span id="modal-title">Add New Car</span></h3>
            <button class="close-modal" id="close-modal">&times;</button>
        </div>
        <div class="modal-body">
            <form id="car-form">
                <input type="hidden" id="car-id">
                
                <div class="form-group">
                    <label for="car-model">Car Model</label>
                    <input type="text" id="car-model" class="form-control" placeholder="e.g., PROTON X70 1.8 PREMIUM" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="car-year">Year</label>
                        <input type="number" id="car-year" class="form-control" placeholder="e.g., 2020" min="1990" max="2030" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="car-price">Price (RM)</label>
                        <input type="text" id="car-price" class="form-control" placeholder="e.g., 64,600" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="car-monthly">Monthly Estimate (RM)</label>
                        <input type="text" id="car-monthly" class="form-control" placeholder="e.g., 802.71">
                    </div>
                    
                    <div class="form-group">
                        <label for="car-plate">Plate Number</label>
                        <input type="text" id="car-plate" class="form-control" placeholder="e.g., VDB7826" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="car-status">Status</label>
                    <select id="car-status" class="form-control">
                        <option value="Available">Available</option>
                        <option value="Sold">Sold</option>
                        <option value="Reserved">Reserved</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Dealership</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="manthong-tag" value="true">
                            <label for="manthong-tag">Man Thong</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="ef-tag" value="true">
                            <label for="ef-tag">Ever Forward</label>
                        </div>
                    </div>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn btn-danger" id="delete-car-btn" style="display: none;">Delete Car</button>
            <button class="btn" id="cancel-btn">Cancel</button>
            <button class="btn btn-primary" id="save-car-btn">Save Car</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="delete-modal">
    <div class="modal">
        <div class="modal-header">
            <h3>⚠️ Confirm Deletion</h3>
            <button class="close-modal" id="close-delete-modal">&times;</button>
        </div>
        <div class="modal-body delete-confirm">
            <p>Are you sure you want to delete this car? This action cannot be undone.</p>
            <div>
                <button class="btn" id="cancel-delete-btn">Cancel</button>
                <button class="btn btn-danger" id="confirm-delete-btn">Delete</button>
            </div>
        </div>
    </div>
</div>

    <div class="footer">
        <p id="last-updated">List Updated: <span id="update-time">Loading...</span></p>
    </div>

</body>
<script>
// ----------------------------------------------------
// 1. Global Variables Initialization
// ----------------------------------------------------
let cars = [];
let currentCarId = null;
const customBrandOrder = [
    "PROTON", "PERODUA", "TOYOTA", "HONDA", "NISSAN",
    "LEXUS", "VOLKSWAGEN", "HYUNDAI", "MERCEDES BENZ", "NAZA"
];

// ----------------------------------------------------
// 2. Local Storage Data Management
// ----------------------------------------------------
function getCars() {
    const storedCars = localStorage.getItem('manthongCars');
    const defaultCars = [
        // --- PROTON ---
        { model: "PROTON X70 1.8 PREMIUM", year: 2019, price: "RM 64,600", monthly: "RM802.71", plateNo: "VDB7826", status: "Available", id: 1, manthongTag: true, efTag: false },
        { model: "PROTON X50 1.5T FLAGSHIP", year: 2021, price: "RM 74,000", monthly: "RM919.52", plateNo: "VGA7888", status: "Available", id: 2, manthongTag: true, efTag: false },
        // --- PERODUA ---
        { model: "PERODUA AXIA 1.0 AV", year: 2015, price: "RM 30,000", monthly: "RM465.28", plateNo: "PMB1745", status: "Available", id: 5, manthongTag: true, efTag: false },
        // --- Ever Forward Cars ---
        { model: "PERODUA MYVI 1.3 SE", year: 2013, price: "RM 25,600", monthly: "", plateNo: "W6139C", status: "Available", id: 45, efTag: true, manthongTag: false }
    ];
    
    if (storedCars) return JSON.parse(storedCars);
    localStorage.setItem('manthongCars', JSON.stringify(defaultCars));
    return defaultCars;
}

function saveCars(carArray) {
    localStorage.setItem('manthongCars', JSON.stringify(carArray));
    displayLastUpdatedTime();
}

function resetToDefaultData() {
    if (confirm("Are you sure you want to reset all data to default? This will delete any cars you've added or modified.")) {
        localStorage.removeItem('manthongCars');
        location.reload();
    }
}

function generateUniqueId() {
    return Date.now();
}

// ----------------------------------------------------
// NEW: 3. Export Data Functionality
// ----------------------------------------------------
function exportCarData() {
    if (cars.length === 0) {
        showNotification('No car data to export', 'error');
        return;
    }

    // 1. Format data as readable JSON
    const carDataStr = JSON.stringify(cars, null, 2);
    
    // 2. Create filename with current date (e.g., car_data_20251018.json)
    const today = new Date();
    const dateStr = today.getFullYear() + 
                   String(today.getMonth() + 1).padStart(2, '0') + 
                   String(today.getDate()).padStart(2, '0');
    const fileName = `car_data_${dateStr}.json`;
    
    // 3. Create download link
    const blob = new Blob([carDataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const downloadLink = document.createElement('a');
    
    downloadLink.href = url;
    downloadLink.download = fileName;
    document.body.appendChild(downloadLink);
    downloadLink.click();
    
    // 4. Clean up
    document.body.removeChild(downloadLink);
    URL.revokeObjectURL(url);
    
    // 5. Show success message
    showNotification(`Car data exported: ${fileName}`, 'success');
}

// ----------------------------------------------------
// 4. Modal Operations
// ----------------------------------------------------
function openAddCarModal(carModal, carForm) {
    document.getElementById('modal-title').textContent = 'Add New Car';
    document.getElementById('modal-icon').textContent = '🚗';
    document.getElementById('delete-car-btn').style.display = 'none';
    carForm.reset();
    currentCarId = null;
    carModal.classList.add('active');
}

function openEditCarModal(carModal, carId) {
    const car = cars.find(c => c.id === carId);
    if (!car) return;

    document.getElementById('modal-title').textContent = 'Edit Car';
    document.getElementById('modal-icon').textContent = '✏️';
    document.getElementById('delete-car-btn').style.display = 'block';

    // Populate form with car data
    document.getElementById('car-id').value = car.id;
    document.getElementById('car-model').value = car.model;
    document.getElementById('car-year').value = car.year;
    document.getElementById('car-price').value = car.price.replace('RM ', '');
    document.getElementById('car-monthly').value = car.monthly.replace('RM ', '') || '';
    document.getElementById('car-plate').value = car.plateNo;
    document.getElementById('car-status').value = car.status;
    document.getElementById('manthong-tag').checked = car.manthongTag;
    document.getElementById('ef-tag').checked = car.efTag;

    currentCarId = carId;
    carModal.classList.add('active');
}

function closeAllModals(carModal, deleteModal) {
    carModal.classList.remove('active');
    deleteModal.classList.remove('active');
}

// ----------------------------------------------------
// 5. Car Data Management
// ----------------------------------------------------
function saveCarData(carModal, deleteModal, carForm) {
    // Get form values
    const model = document.getElementById('car-model').value.trim();
    const year = parseInt(document.getElementById('car-year').value);
    const price = document.getElementById('car-price').value.trim();
    const monthly = document.getElementById('car-monthly').value.trim();
    const plateNo = document.getElementById('car-plate').value.trim();
    const status = document.getElementById('car-status').value;
    const manthongTag = document.getElementById('manthong-tag').checked;
    const efTag = document.getElementById('ef-tag').checked;

    // Validate required fields
    if (!model || !year || !price || !plateNo) {
        showNotification('Please fill in all required fields (Model, Year, Price, Plate Number)', 'error');
        return;
    }

    // Format car data
    const carData = {
        model,
        year,
        price: price.includes('RM') ? price : `RM ${price}`,
        monthly: monthly ? (monthly.includes('RM') ? monthly : `RM ${monthly}`) : '',
        plateNo,
        status,
        manthongTag,
        efTag
    };

    // Update existing car or add new car
    if (currentCarId) {
        const index = cars.findIndex(c => c.id === currentCarId);
        if (index !== -1) {
            carData.id = currentCarId;
            cars[index] = carData;
            showNotification('Car updated successfully', 'success');
        }
    } else {
        carData.id = generateUniqueId();
        cars.push(carData);
        showNotification('Car added successfully', 'success');
    }

    saveCars(cars);
    renderCarList(cars);
    closeAllModals(carModal, deleteModal);
}

function deleteCarData(carModal, deleteModal) {
    if (!currentCarId) return;
    
    const confirmation = confirm("Are you sure you want to delete this car? This action cannot be undone.");
    if (!confirmation) return;

    const index = cars.findIndex(c => c.id === currentCarId);
    if (index !== -1) {
        cars.splice(index, 1);
        saveCars(cars);
        renderCarList(cars);
        showNotification('Car deleted successfully', 'success');
    }
    
    closeAllModals(carModal, deleteModal);
}

// ----------------------------------------------------
// 6. Notification System
// ----------------------------------------------------
function showNotification(message, type) {
    const notification = document.createElement('div');
    notification.textContent = message;
    notification.style.cssText = `
        position: fixed; top: 20px; right: 20px; padding: 12px 20px;
        border-radius: 6px; color: white; font-weight: 600; z-index: 3000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15); animation: slideIn 0.3s ease-out;
    `;
    
    notification.style.backgroundColor = type === 'success' ? '#28a745' : '#dc3545';
    document.body.appendChild(notification);

    // Auto remove after 3 seconds
    setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease-in';
        setTimeout(() => notification.remove(), 300);
    }, 3000);
}

// ----------------------------------------------------
// 7. Car List Rendering
// ----------------------------------------------------
function renderCarItems(list, containerElement) {
    list.forEach(car => {
        const whatsappLink = `https://wa.me/60105000111?text=Hi%2C%20I'm%20interested%20in%20the%20${encodeURIComponent(car.model)}%20${car.year}%2C%20Plate%20No%3A%20${car.plateNo}%2E`;
        
        // Generate tags HTML
        let tagHtml = '';
        if (car.efTag) tagHtml += '<span class="ef-tag tag-top-left">EF</span>';
        if (car.manthongTag && !car.efTag) tagHtml += '<span class="manthong-tag tag-top-left">MT</span>';

        const carItem = document.createElement('li');
        carItem.className = 'car-item';
        carItem.setAttribute('data-car-id', car.id);
        carItem.innerHTML = `
            ${tagHtml}
            <button class="edit-car-btn" style="position:absolute; top:10px; right:10px; background:#6c757d; color:white; border:none; border-radius:4px; padding:5px 10px; cursor:pointer; font-size:12px;">✏️ Edit</button>
            <h3 class="car-title">${car.model}</h3>
            <p class="car-year">Year: ${car.year}</p>
            <p class="car-plateno">Plate No: <strong>${car.plateNo}</strong></p>
            <p class="car-price">Price: ${car.price}</p>
            <p class="car-monthly">Monthly Estimate: <strong>${car.monthly || 'N/A'}</strong></p>
            <p><strong>Status:</strong> <span class="car-status">${car.status}</span></p>
            <a href="${whatsappLink}" target="_blank" class="whatsapp-btn">📲 INQUIRE NOW</a>
        `;
        containerElement.appendChild(carItem);
    });
}

function renderCarList(carArray) {
    const container = document.getElementById('car-container');
    container.innerHTML = '';

    // Group cars by brand
    const groupedByBrand = carArray.reduce((acc, car) => {
        let brand = car.model.split(' ')[0].toUpperCase();
        if (brand === 'MERCEDES') brand = 'MERCEDES BENZ';
        if (!acc[brand]) acc[brand] = [];
        acc[brand].push(car);
        return acc;
    }, {});

    // Sort brands using custom order
    const sortedBrands = customBrandOrder.filter(brand => groupedByBrand[brand])
        .concat(Object.keys(groupedByBrand).filter(brand => !customBrandOrder.includes(brand)));

    // Render each brand group
    sortedBrands.forEach(brand => {
        const brandCars = groupedByBrand[brand];
        if (brandCars.length === 0) return;

        container.innerHTML += `<h2 class="brand-category-title">🚗 ${brand}</h2>`;

        // Separate by dealership
        const manthongCars = brandCars.filter(car => car.manthongTag);
        const efCars = brandCars.filter(car => car.efTag);

        // Render Man Thong cars
        if (manthongCars.length > 0) {
            container.innerHTML += `<h3 class="dealership-separator">⭐ Man Thong Auto Trading ⭐</h3>`;
            const mtList = document.createElement('ul');
            mtList.className = 'car-list';
            renderCarItems(manthongCars.sort((a, b) => b.year - a.year), mtList);
            container.appendChild(mtList);
        }

        // Render Ever Forward cars
        if (efCars.length > 0) {
            container.innerHTML += `<h3 class="dealership-separator">🌟 Ever Forward Auto Trading 🌟</h3>`;
            const efList = document.createElement('ul');
            efList.className = 'car-list';
            renderCarItems(efCars.sort((a, b) => b.year - a.year), efList);
            container.appendChild(efList);
        }
    });

    // Show message if no cars found
    if (carArray.length === 0) {
        container.innerHTML = '<h2 class="brand-category-title" style="border-bottom:none; color:#dc3545;">No matching cars found</h2>';
    }
}

// ----------------------------------------------------
// 8. Loan Calculator
// ----------------------------------------------------
function calculateMonthlyPayment(principal, years, rate) {
    const totalInterest = principal * rate * years;
    const totalLoanAmount = principal + totalInterest;
    return totalLoanAmount / (years * 12);
}

function updateLoanCalculation() {
    const otrPrice = parseFloat(document.getElementById('otr-price').value) || 0;
    const downPayment = parseFloat(document.getElementById('down-payment').value) || 0;
    const loanYears = parseInt(document.getElementById('loan-years').value) || 0;
    const interestRate = parseFloat(document.getElementById('interest-rate').value) || 0;
    const resultElement = document.getElementById('monthly-payment-result');

    // Validate inputs
    if (otrPrice <= downPayment || loanYears <= 0 || interestRate <= 0) {
        resultElement.innerHTML = `RM 0.00<span>Please ensure OTR > Down Payment and all values are positive</span>`;
        return;
    }

    // Calculate and display result
    const principal = otrPrice - downPayment;
    const monthlyPayment = calculateMonthlyPayment(principal, loanYears, interestRate);
    resultElement.innerHTML = `RM ${monthlyPayment.toFixed(2)}<span>Estimated Monthly Payment (${loanYears} Years, ${(interestRate * 100).toFixed(1)}%)</span>`;
}

// ----------------------------------------------------
// 9. Update Time Display
// ----------------------------------------------------
function displayLastUpdatedTime() {
    const now = new Date();
    const dateString = now.toLocaleDateString('en-US', {
        year: 'numeric', month: 'short', day: 'numeric',
        hour: '2-digit', minute: '2-digit', second: '2-digit',
        hour12: false, timeZone: 'Asia/Kuala_Lumpur'
    });
    document.getElementById('update-time').textContent = dateString + ' MYT';
}

// ----------------------------------------------------
// 10. Event Listeners Initialization
// ----------------------------------------------------
function initializeEventListeners(carModal, deleteModal, carForm) {
    // 1. Add Export Data button
    const exportBtn = document.createElement('button');
    exportBtn.className = 'btn btn-primary';
    exportBtn.innerHTML = '<span>📤</span> Export Data';
    exportBtn.addEventListener('click', exportCarData);
    document.querySelector('.action-buttons').appendChild(exportBtn);
    // 在 initializeEventListeners 函数中添加
    const githubImportBtn = document.createElement('button');
    githubImportBtn.className = 'btn btn-primary';
    githubImportBtn.innerHTML = '<span>🔄</span> Import from GitHub';
    githubImportBtn.addEventListener('click', importFromGitHub);
    document.querySelector('.action-buttons').appendChild(githubImportBtn);

    // 2. Add car button
    document.getElementById('add-car-btn').addEventListener('click', () => {
        openAddCarModal(carModal, carForm);
    });

    // 3. Save and reset buttons
    document.getElementById('save-data-btn').addEventListener('click', () => {
        saveCars(cars);
        showNotification('Data saved successfully', 'success');
    });
    
    document.getElementById('reset-data-btn').addEventListener('click', resetToDefaultData);

    // 4. Save car button
    document.getElementById('save-car-btn').addEventListener('click', () => {
        saveCarData(carModal, deleteModal, carForm);
    });

    // 5. Delete functionality
    document.getElementById('delete-car-btn').addEventListener('click', () => {
        deleteModal.classList.add('active');
    });
    
    document.getElementById('confirm-delete-btn').addEventListener('click', () => {
        deleteCarData(carModal, deleteModal);
    });

    // 6. Close modals
    document.getElementById('close-modal').addEventListener('click', () => {
        closeAllModals(carModal, deleteModal);
    });
    
    document.getElementById('close-delete-modal').addEventListener('click', () => {
        closeAllModals(carModal, deleteModal);
    });
    
    document.getElementById('cancel-btn').addEventListener('click', () => {
        closeAllModals(carModal, deleteModal);
    });
    
    document.getElementById('cancel-delete-btn').addEventListener('click', () => {
        closeAllModals(carModal, deleteModal);
    });

    // 7. Edit car functionality (event delegation)
    document.getElementById('car-container').addEventListener('click', (e) => {
        if (e.target.classList.contains('edit-car-btn')) {
            const carId = parseInt(e.target.closest('.car-item').getAttribute('data-car-id'));
            openEditCarModal(carModal, carId);
        }
    });

    // 8. Search functionality
    document.getElementById('search-input').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredCars = cars.filter(car => 
            car.model.toLowerCase().includes(searchTerm) ||
            car.year.toString().includes(searchTerm) ||
            car.plateNo.toLowerCase().includes(searchTerm)
        );
        renderCarList(filteredCars);
    });

    // 9. Calculator functionality
    const calculatorInputs = [
        document.getElementById('otr-price'),
        document.getElementById('down-payment'),
        document.getElementById('loan-years'),
        document.getElementById('interest-rate')
    ];
    calculatorInputs.forEach(input => {
        input.addEventListener('input', updateLoanCalculation);
    });

    // 10. Calculator toggle
    document.getElementById('calc-toggle').addEventListener('click', () => {
        const popup = document.getElementById('calculator-popup');
        const toggleBtn = document.getElementById('calc-toggle');
        
        if (popup.style.display === 'block') {
            popup.style.display = 'none';
            toggleBtn.innerHTML = '&#x270E;';
        } else {
            popup.style.display = 'block';
            toggleBtn.innerHTML = '&#x2715;';
            updateLoanCalculation();
        }
    });
}

// ----------------------------------------------------
// 11. Initialization on Page Load
// ----------------------------------------------------
document.addEventListener('DOMContentLoaded', () => {
    // Get DOM elements
    const carModal = document.getElementById('car-modal');
    const deleteModal = document.getElementById('delete-modal');
    const carForm = document.getElementById('car-form');

    // Initialize data
    cars = getCars();

    // Render cars
    renderCarList(cars);

    // Setup event listeners
    initializeEventListeners(carModal, deleteModal, carForm);

    // Initialize calculator and time display
    updateLoanCalculation();
    displayLastUpdatedTime();
});
// 从 GitHub 加载 JSON 数据（替换为你的文件地址）
async function importFromGitHub() {
    const githubJsonUrl = "https://raw.githubusercontent.com/Zay623/REAL/main/car_data_20251018 (1) ";
    
    try {
        const response = await fetch(githubJsonUrl);
        if (!response.ok) throw new Error("Failed to load data");
        
        const importedCars = await response.json();
        cars = importedCars; // 替换现有车辆数据
        saveCars(cars); // 保存到本地存储
        renderCarList(cars); // 重新渲染列表
        showNotification("Data imported from GitHub successfully", "success");
    } catch (error) {
        showNotification("Failed to import data: " + error.message, "error");
    }
}
</script>
</body>
</html>
